app: data-scraper-app
service: data-scraper-app

plugins:
  - serverless-plugin-typescript
  - serverless-step-functions

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs14.x
  iam:
    deploymentRole: 'arn:aws:iam::104843235006:role/data-scraper-app-CloudFormationExecutionRole'

functions:
  getGames:
    handler: src/handler.getGames
  
  getPlays:
    handler: src/handler.getPlays

stepFunctions:
  stateMachines:
    ScrapeDataForYear:
      type: EXPRESS
      loggingConfig:
        level: ALL
        includeExecutionData: true
        destinations:
          - Fn::GetAtt: [ScrapeDataForYearLogGroup, Arn]
      definition:
        StartAt: GetGames
        States:
          GetGames:
            Type: Task
            Resource:
              Fn::GetAtt: [getGames, Arn]
            OutputPath: $.Payload
            Next: ScrapeDataForAllGames
          ScrapeDataForAllGames:
            Type: Map
            Parameters:
              $: $$.Map.Item.Value
            Iterator:
              StartAt: GetPlays
              States:
                GetPlays:
                  Type: Task
                  Resource:
                    Fn::GetAtt: [getPlays, Arn]
                  ResultSelector:
                    $: $.Payload
                  ResultPath: $.plays
                  Next: WritePlaysToDynamo
                WritePlaysToDynamo:
                  Type: Task
                  Resource:
                    Fn::ImportValue: sls-data-storage-${sls:stage}-WritePlaysToDynamoLambdaFunctionQualifiedArn
                  End: true
            ResultPath: null
            End: true

resources:
  Resources:
    ScrapeDataForYearLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: !Join [ /, [ stepFunctions, ScrapeDataForYear]]
